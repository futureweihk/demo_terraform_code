- name: Manage Terraform Infrastructure
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    # Path to the directory containing main.tf (relative to repo root)
    terraform_project_path: "./" 
    # State can be 'present' (apply) or 'absent' (destroy)
    terraform_state: "present"
    # Force init to ensure backend config is fresh
    terraform_force_init: false
    # Location of backend config
    backend_config_file: "environments/dev/backend.tf"
    # Location of tfvars
    tfvars_file: "environments/dev/terraform.tfvars"

  tasks:
    # ---------------------------------------------------------
    # 1. Pre-flight Checks
    # ---------------------------------------------------------
    - name: "Log: Check config file exist"
      ansible.builtin.stat:
        path: "{{ terraform_project_path }}/{{ backend_config_file }}"
      register: backend_file

    - name: "Log: fail if backend file not exist"
      ansible.builtin.assert:
        that:
          - backend_file.stat.exists
        fail_msg: "Backend config file NOT found at {{ terraform_project_path }}/{{ backend_config_file }}"
        success_msg: "Backend config file found."

    # ---------------------------------------------------------
    # 2. Planning (Only runs if state is 'present')
    # ---------------------------------------------------------
    - name: "Log: Starting Terraform Plan (Creation/Update)"
      debug:
        msg: "Generating Terraform Plan for creation..."
      when: terraform_state == "present"

    - name: Plan Terraform changes
      community.general.terraform:
        project_path: "{{ terraform_project_path }}"
        state: planned
        variables_file: "{{ tfvars_file }}"
        plan_file: "tfplan"
        force_init: "{{ terraform_force_init }}"
        # Dynamic backend config
        backend_config:
          config_path: "{{ backend_config_file }}"
      register: tf_plan_result
      ignore_errors: true
      when: terraform_state == "present"

    - name: Show Terraform Plan Output
      debug:
        var: tf_plan_result.stdout_lines
      when: terraform_state == "present" and tf_plan_result.stdout is defined

    - name: Fail if Plan failed
      fail:
        msg: "Terraform Plan failed. See above logs."
      when: terraform_state == "present" and tf_plan_result.failed

    # ---------------------------------------------------------
    # 3. Apply (Only runs if state is 'present')
    # ---------------------------------------------------------
    - name: "Log: Applying Terraform Plan"
      debug:
        msg: "Applying the generated tfplan..."
      when: terraform_state == "present"

    - name: Apply Terraform changes
      community.general.terraform:
        project_path: "{{ terraform_project_path }}"
        state: present
        plan_file: "tfplan"
        # We don't need variables_file here because we are using a plan_file
        force_init: "{{ terraform_force_init }}"
        backend_config:
          config_path: "{{ backend_config_file }}"
      register: tf_apply_result
      ignore_errors: true
      when: terraform_state == "present"

    - name: Show Terraform Apply Output
      debug:
        var: tf_apply_result.stdout_lines
      when: terraform_state == "present" and tf_apply_result.stdout is defined

    - name: Fail if Apply failed
      fail:
        msg: "Terraform Apply failed."
      when: terraform_state == "present" and tf_apply_result.failed

    # ---------------------------------------------------------
    # 4. Destroy (Only runs if state is 'absent')
    # ---------------------------------------------------------
    - name: "Log: Starting Terraform Destroy"
      debug:
        msg: "WARNING: Destroying infrastructure in {{ terraform_project_path }}"
      when: terraform_state == "absent"

    - name: Destroy Terraform Infrastructure
      community.general.terraform:
        project_path: "{{ terraform_project_path }}"
        state: absent
        variables_file: "{{ tfvars_file }}"
        force_init: "{{ terraform_force_init }}"
        backend_config:
          config_path: "{{ backend_config_file }}"
      register: tf_destroy_result
      ignore_errors: true
      when: terraform_state == "absent"

    - name: Show Terraform Destroy Output
      debug:
        var: tf_destroy_result.stdout_lines
      when: terraform_state == "absent" and tf_destroy_result.stdout is defined

    - name: Fail if Destroy failed
      fail:
        msg: "Terraform Destroy failed."
      when: terraform_state == "absent" and tf_destroy_result.failed